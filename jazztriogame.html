<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jazz Trio Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Darumadrop+One&family=Sawarabi+Mincho&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Sawarabi Mincho', serif;
      background: #000000;
      color: #fff;
      overflow: hidden;
    }
    body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: 0;
        background: url('https://i.imgur.com/mn5vtU3.jpg') center center / cover no-repeat;
        opacity: 0.1;
        pointer-events: none;
    }
    /* Prevent selection and copying of progress bar emojis */
    #progress-bar-content span {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        pointer-events: none;
    }
    #title, h2 {
      font-family: 'Darumadrop One', cursive;
    }
    .centered {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .btn {
      font-family: 'Sawarabi Mincho', serif;
      background: #1e4182;
      border: none;
      padding: 1rem 2rem;
      margin: 1rem;
      border-radius: 12px;
      font-size: 1.2rem;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .btn:hover, .btn:focus {
      background: #c951a9;
      outline: none;
    }
    .btn[disabled] {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }
    #title {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    #subtitle {
      font-size: 1.2rem;
      color: #ccc;
    }
    #menu, #rules, #game, #pauseMenu, #winScreen, #adminPanel, #testProgressBar {
      display: none;
    }
    #pauseMenu {
        padding: 2rem 0 1rem 0;
        width: 370px;
        min-width: 220px;
        border-radius: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        height: 230px; /* much shorter than win screen */
    }   
    #pauseMenu > h2,
    #pauseMenu > .btn {
        padding-left: 1em;
        padding-right: 3em;
    }
    #winScreen > h2 {
      padding: 0em 2em 0em 2em;
      margin: 0 0 0.2em 0;
      text-align: center;
    }
    .floating-emoji {
      font-size: 4rem;
      position: absolute;
      animation: float 2s infinite ease-in-out, emoji-in 0.7s cubic-bezier(.68,-0.55,.27,1.55);
      pointer-events: none;
      user-select: none;
      will-change: transform, filter;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      pointer-events: none;
    }
    @keyframes float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }
    @keyframes emoji-in {
      0% {
        opacity: 0;
        transform: scale(0) translateY(30px);
      }
      60% {
        opacity: 1;
        transform: scale(1.15) translateY(-10px);
      }
      80% {
        transform: scale(0.95) translateY(5px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    @keyframes emoji-out {
      0% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
      30% {
        transform: scale(1.15) translateY(-10px);
      }
      60% {
        transform: scale(0.7) translateY(20px);
      }
      100% {
        opacity: 0;
        transform: scale(0) translateY(40px);
      }
    }
    .blurred {
      filter: blur(4px);
    }
    /* Pause and blur floating emojis when .paused or .scoreboard-blur is on body */
    body.paused .floating-emoji,
    body.scoreboard-blur .floating-emoji {
        animation-play-state: paused !important;
        filter: blur(4px);
    }
    .overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #0c2148;
      border-radius: 20px;
      padding: 2rem 0 1rem 0;
      z-index: 10;
      width: 370px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      box-sizing: border-box;
      height: 560px;
      justify-content: flex-start;
    }
    #progress-bar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 30px;
      background: #0c2148;
      border-radius: 15px;
      font-size: 1.5rem;
      z-index: 2;
      overflow: hidden;
      padding: 0 18px;
      box-sizing: border-box;
    }
    #progress-fill, #test-progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: #c951a979;
      border-radius: 15px;
      width: 0;
      z-index: 1;
      transition: width 0.3s cubic-bezier(.68,-0.55,.27,1.55);
      pointer-events: none;
    }
    #progress-bar-content {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0;
      font-size: 1.6rem;
    }
    #testProgressBar .btn {
      display: none;
    }
    .scoreboard-header,
    .scoreboard-footer {
      padding-left: 2em;
      padding-right: 2em;
    }
    .scoreboard-header {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      font-size: 1.3em;
      padding-top: 0.5em;
      padding-bottom: 0.2em;
      background: transparent;
      flex: 0 0 auto;
    }
    .scoreboard-scrollbox-wrapper {
      position: relative;
      margin: 0 1.2em 0.5em 1.2em;
    }
    .scoreboard-rows {
      background: #5180d8;
      border-radius: 16px;
      max-height: 250px;
      min-height: 250px;
      overflow-y: auto;
      font-size: 1.1em;
      position: relative;
      z-index: 1;
    }
    .scoreboard-row {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
      min-height: 25px;
      align-items: center;
      padding-left: 1em;
      padding-right: 1em;
    }
    .scoreboard-footer {
      font-size: 1.1em;
      text-align: left;
      padding-top: 0.5em;
      padding-bottom: 0.5em;
      background: transparent;
      flex: 0 0 auto;
    }
    .scoreboard-buttons {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 1em 0 0 0;
      flex: 0 0 auto;
    }
    .scoreboard-shadow {
      position: absolute;
      left: 0; right: 0;
      height: 24px;
      pointer-events: none;
      z-index: 2;
      border-radius: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .scoreboard-shadow-top {
      top: 0;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.469), rgba(0,0,0,0));
      border-radius: 16px 16px 0 0;
    }
    .scoreboard-shadow-bottom {
      bottom: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.469), rgba(0,0,0,0));
      border-radius: 0 0 16px 16px;
    }
    .scoreboard-scrollbox-wrapper.show-shadow-top .scoreboard-shadow-top {
      opacity: 1;
    }
    .scoreboard-scrollbox-wrapper.show-shadow-bottom .scoreboard-shadow-bottom {
      opacity: 1;
    }
    /* Hide scrollbar for Chrome, Safari and Opera */
    .scoreboard-rows::-webkit-scrollbar {
        display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .scoreboard-rows {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;     /* Firefox */
    }
  </style>
</head>
<body>
  <div id="menu" class="centered" aria-label="Main Menu">
    <div id="title" tabindex="0">Jazz Trio Game</div>
    <div id="subtitle" tabindex="0">(drums, bass, keys)</div>
    <button class="btn" onclick="showRules()" aria-label="Show Rules">How to Play</button>
    <button class="btn" onclick="startGame()" aria-label="Start Game">Start Game</button>
  </div>

  <div id="rules" class="centered" aria-label="Game Rules">
    <h2 id="title" tabindex="0">How to Play</h2>
    <p>Get ü•Å üé∏ üéπ in order!</p>
    <p>Click, tap, or press <b>SPACE</b> or <b>ENTER</b> to generate an instrument emoji.</p>
    <p>ESC pauses the game. Get the trio in order to win!</p>
    <button class="btn" onclick="backToMenu()" aria-label="Back to Menu">Back</button>
  </div>

  <div id="game" aria-label="Game Area">
    <div id="progress-bar" aria-label="Progress Bar" tabindex="0">
      <div id="progress-fill" aria-hidden="true"></div>
      <div id="progress-bar-content">
        <span aria-label="Drums">ü•Å</span><span aria-label="Bass">üé∏</span><span aria-label="Keys">üéπ</span>
      </div>
    </div>
  </div>

  <div id="pauseMenu" class="overlay" style="display:none" aria-label="Pause Menu">
    <h2 tabindex="0">Paused</h2>
    <button class="btn" onclick="resumeGame()" aria-label="Continue Game">Continue</button>
    <button class="btn" onclick="backToMenu(false)" aria-label="Quit to Menu">Quit</button>
  </div>

  <div id="winScreen" class="overlay" style="display:none" aria-label="Win Screen">
    <h2 tabindex="0">YAY you got the jazz trio!!</h2>
    <div class="scoreboard-header">
      <span>Session</span>
      <span>Tries</span>
    </div>
    <div class="scoreboard-scrollbox-wrapper">
      <div class="scoreboard-shadow scoreboard-shadow-top"></div>
      <div class="scoreboard-rows" id="scoreboard-rows"></div>
      <div class="scoreboard-shadow scoreboard-shadow-bottom"></div>
    </div>
    <div class="scoreboard-footer" id="scoreboard-footer"></div>
    <div class="scoreboard-buttons">
      <button class="btn" onclick="startGame()" aria-label="Play Again">Play Again?</button>
      <button class="btn" onclick="backToMenu(false)" aria-label="Quit to Menu">Quit</button>
    </div>
  </div>

  <!-- Admin Panel (hidden unless code is entered) -->
  <div id="adminPanel" class="centered" aria-label="Admin Panel">
    <h2>Admin Controls</h2>
    <button class="btn" onclick="showTestWin()" id="adminBtnWin">Test Win Screen</button>
    <button class="btn" onclick="showTestPause()" id="adminBtnPause">Test Pause Screen</button>
    <button class="btn" onclick="showTestProgress()" id="adminBtnProgress">Test Progress Bar</button>
    <button class="btn" onclick="backToMenu(true)" id="adminBtnMenu">Main Menu</button>
  </div>

  <!-- Test Progress Bar Screen -->
  <div id="testProgressBar" aria-label="Test Progress Bar">
    <div id="progress-bar">
      <div id="test-progress-fill" aria-hidden="true" style="width:0"></div>
      <div id="progress-bar-content">
        <span aria-label="Drums">ü•Å</span><span aria-label="Bass">üé∏</span><span aria-label="Keys">üéπ</span>
      </div>
    </div>
  </div>

  <script>
    // --- GAME LOGIC (unchanged except no audio references) ---
    let progress = 0;
    let tries = 0;
    let gameActive = false;
    let session = [];
    let skillzCount = 0;

    const instruments = ["ü•Å", "üé∏", "üéπ"];
    const sequence = ["drums-", "bass-", "keys-"];
    let current = "";

    const ADMIN_CODE = "QXVyaVBsYXl6SmF6ejg0MTk=";
    let adminBuffer = "";

    function hideAll() {
      ["menu", "rules", "game", "pauseMenu", "winScreen", "adminPanel", "testProgressBar"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });
    }

    function isMenuVisible() {
      return document.getElementById("menu").style.display === "block";
    }

    document.addEventListener("DOMContentLoaded", () => {
      hideAll();
      document.getElementById("menu").style.display = "block";
    });

    function showRules() {
      hideAll();
      document.getElementById("rules").style.display = "block";
      document.getElementById("rules").focus();
    }

    // backToMenu: if resetSkillz is true, reset skillzCount; otherwise, keep it
    function backToMenu(resetSkillz = false) {
      hideAll();
      document.getElementById("game").classList.remove("blurred");
      document.body.classList.remove("paused");
      document.body.classList.remove("scoreboard-blur");
      document.getElementById("progress-fill").style.width = "0";
      document.getElementById("menu").style.display = "block";
      session = [];
      if (resetSkillz) skillzCount = 0;
      updateScoreboard();
      adminBuffer = "";
    }

    function startGame() {
      hideAll();
      document.getElementById("game").classList.remove("blurred");
      document.body.classList.remove("paused");
      document.body.classList.remove("scoreboard-blur");
      document.getElementById("progress-fill").style.width = "0";
      document.getElementById("game").style.display = "block";
      progress = 0;
      tries = 0;
      current = "";
      gameActive = true;
      adminBuffer = "";
    }

    function pauseGame() {
      if (!gameActive) return;
      document.getElementById("game").classList.add("blurred");
      document.body.classList.add("paused");
      document.getElementById("pauseMenu").style.display = "block";
      gameActive = false;
      document.getElementById("pauseMenu").focus();
    }

    function resumeGame() {
      document.getElementById("game").classList.remove("blurred");
      document.body.classList.remove("paused");
      document.getElementById("pauseMenu").style.display = "none";
      gameActive = true;
    }

    function winGame() {
      document.getElementById("game").classList.add("blurred");
      document.body.classList.add("scoreboard-blur");
      document.getElementById("winScreen").style.display = "block";
      session.push(tries);
      if (tries === 3) skillzCount++;
      updateScoreboard();
      document.getElementById("winScreen").focus();
    }

    function updateScoreboard() {
      const rows = document.getElementById("scoreboard-rows");
      if (!session.length) {
        rows.innerHTML = "";
      } else {
        rows.innerHTML = session.map((tries, i) =>
          `<div class="scoreboard-row"><span>${i + 1}</span><span>${tries}</span></div>`
        ).join("");
      }
      document.getElementById("scoreboard-footer").innerText = `Jazz Trio in 3 tries: ${skillzCount}`;
      const wrapper = rows.parentElement;
      function updateScrollShadows() {
        wrapper.classList.toggle('show-shadow-top', rows.scrollTop > 0);
        wrapper.classList.toggle('show-shadow-bottom', rows.scrollTop + rows.clientHeight < rows.scrollHeight);
      }
      rows.removeEventListener('scroll', updateScrollShadows);
      rows.addEventListener('scroll', updateScrollShadows);
      setTimeout(updateScrollShadows, 0);
    }

    function getRandomCenterCoords() {
      const centerWidth = window.innerWidth * 0.5;
      const centerHeight = window.innerHeight * 0.5;
      const minX = window.innerWidth * 0.25;
      const minY = window.innerHeight * 0.25;
      const x = minX + Math.random() * centerWidth;
      const y = minY + Math.random() * centerHeight;
      return { x, y };
    }

    function spawnEmoji(x, y, symbol) {
      const e = document.createElement("div");
      e.className = "floating-emoji";
      e.innerText = symbol;
      const size = 64;
      e.style.left = `${Math.max(0, Math.min(x, window.innerWidth - size))}px`;
      e.style.top = `${Math.max(0, Math.min(y, window.innerHeight - size))}px`;
      document.body.appendChild(e);

      setTimeout(() => {
        e.style.animation = "float 2s infinite ease-in-out, emoji-out 0.4s cubic-bezier(.68,-0.55,.27,1.55)";
        e.addEventListener("animationend", () => {
          if (e.parentNode) e.parentNode.removeChild(e);
        }, { once: true });
      }, 2000);
    }

    function handleInput(e) {
      if (!gameActive) return;
      if (
        e.target &&
        (e.target.closest('button') ||
         e.target.closest('#menu') ||
         e.target.closest('#rules') ||
         e.target.closest('#pauseMenu') ||
         e.target.closest('#winScreen'))
      ) {
        return;
      }
      if (e.type === "keydown") {
        if (
          !(e.key === " " || e.key === "Enter" || e.code === "Space" || e.code === "Enter")
        ) {
          return;
        }
      }
      tries++;
      const roll = Math.floor(Math.random() * 3);
      const emoji = instruments[roll];
      const word = sequence[roll];
      const { x, y } = getRandomCenterCoords();
      spawnEmoji(x, y, emoji);

      if (word === "drums-") {
        current = "drums-";
        progress = 1;
      } else if (word === "bass-" && current === "drums-") {
        current += "bass-";
        progress = 2;
      } else if (word === "keys-" && current === "drums-bass-") {
        current += "keys-";
        progress = 3;
      } else {
        current = "";
        progress = 0;
      }
      document.getElementById("progress-fill").style.width = `${progress * 100}px`;
      if (progress === 3) {
        gameActive = false;
        winGame();
      }
    }

    // --- ADMIN PANEL LOGIC (unchanged) ---
    document.addEventListener("keydown", function adminKeyListener(e) {
      if (
        document.getElementById("menu").style.display !== "block" ||
        document.getElementById("adminPanel").style.display === "block" ||
        document.getElementById("testProgressBar").style.display === "block"
      ) return;
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "v") {
        navigator.clipboard.readText().then(text => {
          adminBuffer += text;
          checkAdminCode();
        });
        return;
      }
      if (e.key.length === 1) {
        adminBuffer += e.key;
        checkAdminCode();
      }
    });

    function checkAdminCode() {
      if (adminBuffer.includes(ADMIN_CODE)) {
        adminBuffer = "";
        showAdminPanel();
      } else if (adminBuffer.length > 100) {
        adminBuffer = adminBuffer.slice(-100);
      }
    }

    function showAdminPanel() {
      hideAll();
      document.getElementById("adminPanel").style.display = "block";
      document.querySelectorAll('#adminPanel .btn').forEach(btn => btn.disabled = false);
    }

    function showTestWin() {
      hideAll();
      document.getElementById("winScreen").style.display = "block";
      document.body.classList.add("scoreboard-blur");
      document.querySelectorAll('#winScreen .btn').forEach(btn => btn.disabled = true);
      let testSession = [];
      let testSkillz = 0;
      updateTestWinScreen();

      function updateTestWinScreen() {
        const rows = document.getElementById("scoreboard-rows");
        if (!testSession.length) {
          rows.innerHTML = "";
        } else {
          rows.innerHTML = testSession.map((tries, i) =>
            `<div class="scoreboard-row"><span>${i + 1}</span><span>${tries}</span></div>`
          ).join("");
        }
        document.getElementById("scoreboard-footer").innerText = `Jazz Trio in 3 tries: ${testSkillz}`;
        const wrapper = rows.parentElement;
        function updateScrollShadows() {
          wrapper.classList.toggle('show-shadow-top', rows.scrollTop > 0);
          wrapper.classList.toggle('show-shadow-bottom', rows.scrollTop + rows.clientHeight < rows.scrollHeight);
        }
        rows.removeEventListener('scroll', updateScrollShadows);
        rows.addEventListener('scroll', updateScrollShadows);
        setTimeout(updateScrollShadows, 0);
      }

      function addTestSession() {
        const tries = Math.floor(Math.random() * 10) + 1;
        testSession.push(tries);
        if (tries === 3) testSkillz++;
        updateTestWinScreen();
      }

      function resetTestSession() {
        testSession = [];
        testSkillz = 0;
        updateTestWinScreen();
      }

      let touchTimer = null;
      document.getElementById("winScreen").ontouchstart = function() {
        touchTimer = setTimeout(() => {
          resetTestSession();
        }, 600);
      };
      document.getElementById("winScreen").ontouchend = function() {
        if (touchTimer) clearTimeout(touchTimer);
      };

      function testWinHandler(e) {
        if (
          e.type === "keydown" &&
          (e.key === " " || e.key === "Enter" || e.code === "Space" || e.code === "Enter")
        ) {
          addTestSession();
        }
        if (
          e.type === "keydown" &&
          (e.key === "Backspace" || e.code === "Backspace")
        ) {
          resetTestSession();
        }
      }

      document.onkeydown = function(e) {
        if (e.key === "Escape") {
          document.onkeydown = null;
          document.querySelectorAll('#winScreen .btn').forEach(btn => btn.disabled = false);
          document.getElementById("winScreen").ontouchstart = null;
          document.getElementById("winScreen").ontouchend = null;
          document.body.classList.remove("scoreboard-blur");
          showAdminPanel();
        } else {
          testWinHandler(e);
        }
      };
      document.getElementById("winScreen").onclick = testWinHandler;
    }

    function showTestPause() {
      hideAll();
      document.getElementById("pauseMenu").style.display = "block";
      document.getElementById("game").classList.add("blurred");
      document.body.classList.add("paused");
      document.querySelectorAll('#pauseMenu .btn').forEach(btn => btn.disabled = true);
      document.onkeydown = function(e) {
        if (e.key === "Escape") {
          document.onkeydown = null;
          document.querySelectorAll('#pauseMenu .btn').forEach(btn => btn.disabled = false);
          document.getElementById("game").classList.remove("blurred");
          document.body.classList.remove("paused");
          showAdminPanel();
        }
      };
    }

    function showTestProgress() {
      hideAll();
      document.getElementById("testProgressBar").style.display = "block";
      let testProgress = 0;
      const fill = document.getElementById("test-progress-fill");
      fill.style.width = "0";

      function setBar() {
        fill.style.width = `${testProgress * 100}px`;
      }

      function advanceBar() {
        testProgress++;
        if (testProgress > 3) testProgress = 0;
        setBar();
      }

      function progressHandler(e) {
        if (
          e.type === "click" ||
          (e.type === "keydown" && (e.key === " " || e.key === "Enter" || e.code === "Space" || e.code === "Enter")) ||
          e.type === "touchstart"
        ) {
          advanceBar();
        }
      }

      document.getElementById("testProgressBar").onclick = progressHandler;
      document.getElementById("testProgressBar").ontouchstart = progressHandler;
      document.onkeydown = function(e) {
        if (e.key === "Escape") {
          document.onkeydown = null;
          document.getElementById("testProgressBar").onclick = null;
          document.getElementById("testProgressBar").ontouchstart = null;
          document.getElementById("testProgressBar").style.display = "none";
          showAdminPanel();
        } else {
          progressHandler(e);
        }
      };
    }

    // --- END ADMIN PANEL LOGIC ---

    document.addEventListener("keydown", e => {
      if (
        document.getElementById("adminPanel").style.display === "block" ||
        document.getElementById("testProgressBar").style.display === "block"
      ) return;

      if (e.key === "Escape") {
        if (gameActive) pauseGame();
      } else if (
        e.key === " " || e.key === "Enter" || e.code === "Space" || e.code === "Enter"
      ) {
        handleInput(e);
      }
    });

    document.addEventListener("click", e => {
      if (
        document.getElementById("adminPanel").style.display === "block" ||
        document.getElementById("testProgressBar").style.display === "block"
      ) return;
      handleInput(e);
    });

    document.addEventListener("touchstart", e => {
      if (
        document.getElementById("adminPanel").style.display === "block" ||
        document.getElementById("testProgressBar").style.display === "block"
      ) return;
      handleInput(e);
    }, {passive: true});
  </script>
</body>
</html>